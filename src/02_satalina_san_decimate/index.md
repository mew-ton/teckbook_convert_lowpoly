# サタリナさんのQuest化対応作業録

## はじめに

細かい手順の解説の前に、私が行ったローポリアバター化の手順を、サタリナさんを使ってまとめていきます。

元のポリゴン数 34,424 に対し、5,000以下を目指します。

## ポリゴン数削減作業

### Blendファイル初期準備

1. Blendファイルを新規作成し、アバター同梱のFBXファイルをインポート
2. 表示しない服・髪のオブジェクトを削除
3. Collectionを複製し、モデルを2つにする。それぞれ、`元データ表示用` `作業用` としてわかりやすい名前にする

![3まで終わった状態](./src/02_satalina_san_decimate/images/00_01_workspace.png)


### 見えない部分を削減

手始めに、確実に見えないポリゴンを先に削除してしまいます。ここでは、服に隠れている肌の部分をゴリゴリなくしちゃいます。消すべきポリゴンは前章で列挙した通りです。

1. スカートの内側を一旦埋めたり、裾の内側を浅くしたりして、服の裏に隠れて見えづらい箇所を完全に見えなくする。これは雑にやっても大丈夫 [^2-1]
2. 絶対に見えない、ほとんど見えない位置にある、肌着の内側、口の中、後頭部などのポリゴンをゴリゴリ消していく (表情表現に使われるポリゴンは残しておく)
3. 削減が終わった状態で、Collectionを複製し、 `自動削減用` としてわかりやすい名前にしておく。
自動削減用Collectionは、メッシュの編集をこれ以上行わない予定なので、万が一やらかした時のバックアップとしても使える。

この時点で、ポリゴン数は 34,424 → 23,676 (-10,748) となっています。

![(1) ごめんネ、下着を見せる気はないの。](./src/02_satalina_san_decimate/images/01_01_inside_skirt.png)

![(2) 歯と舌もほとんど見えない部分なので、消してしまう](./src/02_satalina_san_decimate/images/01_03_delete_inside_mouth.png)

[^2-1]: 押し出し(e)、縮小(s)、中央に結合(m)を使えればなんとかなります


### 目標のポリ数を確認

ポリゴン数を23,676 から7,500以下に削るのを考えるより、各オブジェクト毎に目標のポリ数を設定したほうが、心理的にも楽になります。
サタリナさんの例では、以下の表のように計算できました。これを目標に削っていきます。

|部位|元|7,500目標|5,000目標|
|---:|---:|---:|---:|
|顔(表情含む)    |3,598     |1,139    |759      |
|髪(髪飾り含む) |5,230     |1,656    |1,104   |
|ブラウス         |4,482     |1,419    |946      |
|スカート         |2,558     |810       |540      |
|首                  |108        |34        |22        |
|両手               |3,780     |1,197    |798     |
|両足               |696        |220       |146     |
|靴                  |2,044     |647       |431     |
|角                  |288        |91        |60        |
|羽                  |892        |282       |188     |
|**合計**       |23,676   |7,495     |4,994  |
|**割合**       |-            |31.68% |21.12%|


### 自動削減を参考用に作成

前節で作成した自動削減用のCollectionに対し、<u>モディファイア</u> から、<u>デシメート</u> (英語表記の場合は <u>Decimate</u>) を設定します。

Collection内の各オブジェクトに対し、<u>モディファイア</u>から <u>デシメート</u> を選択します。表示された設定項目について、比率を1.0からじわじわ減らしていき、なんとなくギリギリ形状が維持できていそうなところで止めます。場合によっては、対称設定等も有効にしておくと良いです。「適用」は押しません。

結果を見ると一目瞭然ですが、<u>デシメート</u> を使うと、手軽にローポリ化できますが、トポロジーが維持されなかったり、細かいデティールが崩れてしまいます。
そのため、基本的には、手動のポリ数削減における、**形状を維持するためなら、ここまで雑に削っても大丈夫** という指標として参考に使います。
削減結果によってはそのまま採用してしまっても良いものもあります。

![<u>モディファイア</u>](./src/02_satalina_san_decimate/images/02_01_modifier.png)

![左は<u>デシメート</u>有り (ポリゴン数: 5,302)、右はなし (ポリゴン数: 23,676)](./src/02_satalina_san_decimate/images/02_02_diff_decimated.png)


### ポリゴン数の削減

ここからようやくポリゴン削減のメインの作業です。具体的な方法の解説は次章にて行います。

基本的にやることは、**不要な辺を削除** するか、 **辺をスライドして結合** だけをひたすら繰り返すのみです。具体的なやりかたは、次章にて詳しく説明します。

ひたすらポリゴン数を削り、4995ポリまで減らしました。

![削った後の全体像](./src/02_satalina_san_decimate/images/03_04_all_result.png)

![手の比較: 頂点がかなり密集しているので、比較がわかりやすい。指は関節部分の辺だけ残して他は消しました](./src/02_satalina_san_decimate/images/03_11_diff_hands.png)

![顔と髪の比較: 一番最後にやったので、だいぶやっつけです。もう少し綺麗な成果を出すのは、未来の私がきっとやってくれるでしょう。 **口元だけは、今後の作業のために、ポリゴン数を減らさないでおきます**](./src/02_satalina_san_decimate/images/03_12_diff_head.png)

![服の比較: フリル部分の頂点の密集具合が圧倒的に多いので、形を変えました](./src/02_satalina_san_decimate/images/03_13_diff_cloth.png)

![胸の比較: 形を維持しながらポリ数を削るのは思ったより大変でした](./src/02_satalina_san_decimate/images/03_14_diff_bust.png)

![袖の比較: 袖のシワを完全になくしました](./src/02_satalina_san_decimate/images/03_15_diff_sleeve.png)

<!--
![1. 移動できそうな辺をまとめて選択し・・](./src/02_satalina_san_decimate/images/03_00_select_single_loop.png)

![2. 辺をスライドして、隣接する頂点に重ねる](./src/02_satalina_san_decimate/images/03_01_slided_loop.png)

![3. これを等間隔に繰り返していく](./src/02_satalina_san_decimate/images/03_02_repeat_slided.png)

![4. 重ねた頂点は、「メッシュ」→「マージ」→「距離で」から。これを何度も繰り返す](./src/02_satalina_san_decimate/images/03_03_result.png) -->


## ポリゴン数削減後のデータ修正

### <u>法線</u>の修正

ポリゴンを削減すると、下の画像のように顔に影が入ったり、妙に角ばってしまいます。ポリゴン削減作業の影響で、法線の向きがおかしくなってしまいます。

![](./src/02_satalina_san_decimate/images/04_01_broken_normal.png)

<u>法線</u>を表示してみると、線の方向が各頂点でバラバラになってしまっているのがよく分かると思います。

![](./src/02_satalina_san_decimate/images/04_03_broken_normal_guide.png)

オブジェクトを選択し、ノーマルの <u>自動スムーズ</u> のチェックを外すことで、綺麗に治ります。
とりあえず、全てのオブジェクトにこの設定をしました。

![](./src/02_satalina_san_decimate/images/04_02_fixed_normal.png)


### ボーン削除・ウェイトの調整

以下のボーンが不要になったんので、ついでに消しました

- 消した羽に対応するボーン
- スカートのボーン

また、スカートが足に追従しないのは不自然なので、ウェイトを塗って調整します

※ ウェイト塗りについては本書では解説しません。


### <u>シェイプキー</u>の修正

ポリゴン削減のために、様々な頂点を結合していくと、ポリゴンの<u>法線</u>が崩れてしまい、下記の画像のように、顔に妙な影がついてしまいます。

法線を再計算することで、法線の向きを正しい位置に直し、影のつき方を正しくなるように直します。

![リップシンクで「あ」を発言するとこうなる](./src/02_satalina_san_decimate/images/05_01_broken_shapekey.png)


### テクスチャの修正

靴のオブジェクトから靴紐を削除した影響で、 *テクスチャに靴紐の影が残ったまま*表示されてしまいました。アバター同梱のPSDファイルを編集して、影を消した版のテクスチャを新たに用意します。

## Unityへインポート

### アバターをベイク

### テクスチャの手直し


## 最終確認

### PC向けに一度アップロードする



---
<div style="page-break-before:always"/>