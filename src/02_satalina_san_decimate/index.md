# 全体の作業の流れ (サタリナさんのQuest化対応作業録)

## はじめに

ポリゴン削減からアバターとしてアップするまでの手順は、アバターによって異なる場合があるため、
手順を追って説明するのは難しそうに感じました。

また、実際の作業においても、作業工程が進んで戻ってを繰り返すのは非常に非効率であるため、全体の作業の流れを予め頭に入れておいたほうがよいでしょう。

そこで、私が実際に作業したサタリナさんでのQuest Excellent対応の記録を元に、**全体の作業の流れだけをざっくり解説します**。
次章から、それぞれの工程における細かい作業の解説をします。

元のポリゴン数 34,424 に対し、5,000以下を目指します。

### サタリナさんのスペック

WIP


## 1. ポリゴン数削減作業

### Blendファイル初期準備

1. Blendファイルを新規作成し、アバター同梱のFBXファイルをインポート
2. 表示しない服・髪のオブジェクトを削除
3. Collectionを複製し、モデルを2つにする。それぞれ、`元データ表示用` `作業用` としてわかりやすい名前にする

![3まで終わった状態](./src/02_satalina_san_decimate/images/00_01_workspace.png)

### 裾やスカートを埋める

手始めに、 **見えづらいポリゴンを増やす** 作業をします。例えば、スカートの内側を埋めたり、袖の裾の穴を浅くしたりします。

削減できるポリゴンをできるだけ多くするために、なるべく多くのポリゴンを隠しましょう。

![ごめんネ、下着を見せる気はないの。](./src/02_satalina_san_decimate/images/01_01_inside_skirt.png)

### 見えない部分を削減

手始めに、確実に見えないポリゴンを先に削除してしまいます。ここでは、服に隠れている肌の部分をゴリゴリなくしちゃいます。この作業では、以下のポリゴンを消しました。

- スカート・ブラウス・靴の内側に隠れている素体・肌着
- 歯・舌
- 後頭部・髪の裏側
- **頬染め表情に使用する染め部分が表示されるポリゴン**

頬染めのアニメーションで使うポリゴンの削除については、後ほど行う **頬染めアニメーションのQuest化対応** によって、「確実に見えないポリゴン」となるため、消しておきます。

この時点で、ポリゴン数は 34,424 → 23,676 (-10,748) となっています。

![歯と舌もほとんど見えない部分なので、消してしまう](./src/02_satalina_san_decimate/images/01_03_delete_inside_mouth.png)


### 参考資料用として複製しておく (もしくはバックアップ)

この時点でのCollectionを複製し、 `自動削減用` としてわかりやすい名前に設定しておきます。
このCollectionの各オブジェクトを自動削減し、その結果を参考にこれからポリゴンの削減作業を行っていきます。

また、やらかしたときのバックアップとしても利用できます。

### 目標のポリ数を確認

ポリゴン数を23,676 から7,500以下に削るのを考えるより、各オブジェクト毎に目標のポリ数を設定したほうが、心理的にも楽になります。
サタリナさんの例では、以下の表のように計算できました。これを目標に削っていきます。

|部位|元|7,500目標|5,000目標|
|---:|---:|---:|---:|
|顔(表情含む)    |3,598     |1,139    |759      |
|髪(髪飾り含む) |5,230     |1,656    |1,104   |
|ブラウス         |4,482     |1,419    |946      |
|スカート         |2,558     |810       |540      |
|首                  |108        |34        |22        |
|両手               |3,780     |1,197    |798     |
|両足               |696        |220       |146     |
|靴                  |2,044     |647       |431     |
|角                  |288        |91        |60        |
|羽                  |892        |282       |188     |
|**合計**       |23,676   |7,495     |4,994  |
|**割合**       |-            |31.68% |21.12%|


### 自動削減を参考用に作成

前節で作成した自動削減用のCollectionに対し、<u>モディファイア</u> から、<u>デシメート</u> (英語表記の場合は <u>Decimate</u>) を設定します。

Collection内の各オブジェクトに対し、<u>モディファイア</u>から <u>デシメート</u> を選択します。表示された設定項目について、比率を1.0からじわじわ減らしていき、なんとなくギリギリ形状が維持できていそうなところで止めます。場合によっては、対称設定等も有効にしておくと良いです。「適用」は押しません。

結果を見ると一目瞭然ですが、<u>デシメート</u> を使うと、手軽にローポリ化できますが、トポロジーが維持されなかったり、細かいデティールが崩れてしまいます。
そのため、基本的には、手動のポリ数削減における、**形状を維持するためなら、ここまで雑に削っても大丈夫** という指標として参考に使います。
削減結果によってはそのまま採用してしまっても良いものもあります。

![<u>モディファイア</u>](./src/02_satalina_san_decimate/images/02_01_modifier.png)

![左は<u>デシメート</u>有り (ポリゴン数: 5,302)、右はなし (ポリゴン数: 23,676)](./src/02_satalina_san_decimate/images/02_02_diff_decimated.png)


### ポリゴン数の削減

ここからようやくポリゴン削減のメインの作業です。
具体的な方法の解説は次章にて行います。

私自身は、ポリゴンの削減方法はわかるとはいえ、最適な作り方自体はわからないので、出来栄えには難ありとは思います。
きっと強いモデラーがこの当たりの作り方を解説してくれるでしょう。

基本的にやることは、**不要な辺を削除** するか、 **辺をスライドして結合** だけをひたすら繰り返すのみです。
ひたすらポリゴン数を削り、4943ポリまで減らしました。

![削った後の全体像](./src/02_satalina_san_decimate/images/03_04_all_result.png)

![手の比較: 頂点がかなり密集しているので、比較がわかりやすい。指は関節部分の辺だけ残して他は消しました](./src/02_satalina_san_decimate/images/03_11_diff_hands.png)

![顔と髪の比較: 一番最後にやったので、だいぶやっつけです。もう少し綺麗な成果を出すのは、未来の私がきっとやってくれるでしょう。 **口元だけは、今後の作業のために、ポリゴン数を減らさないでおきます**](./src/02_satalina_san_decimate/images/03_12_diff_head.png)

![服の比較: フリル部分の頂点の密集具合が圧倒的に多いので、形を変えました](./src/02_satalina_san_decimate/images/03_13_diff_cloth.png)

![胸の比較: 形を維持しながらポリ数を削るのは思ったより大変でした](./src/02_satalina_san_decimate/images/03_14_diff_bust.png)

![袖の比較: 袖のシワを完全になくしました](./src/02_satalina_san_decimate/images/03_15_diff_sleeve.png)

## 2. ポリゴン数削減後の微調整

### <u>法線</u>の修正

ポリゴンを削減すると、下の画像のように顔に影が入ったり、妙に角ばってしまいます。
この妙な影は、VRChat上にアップロードした後の見た目にも影響します。

ポリゴン削減作業の影響で、法線の向きおかしくなっているので、忘れずに修正します。

![Before](./src/02_satalina_san_decimate/images/04_01_broken_normal.png)

![After](./src/02_satalina_san_decimate/images/04_02_fixed_normal.png)

### 不要なボーン削除とウェイトの塗り直し

PCアバターとしてはダイナミックボーン用に用意されていた、羽やスカートのボーンについて、
Excellent対応でボーン数をへらす必要があるため、削除します。

(Excellent対応でなくても、ダイナミックボーンが使えない制約上、削除しておいたほうがよさそうです)

また、スカートにウェイトを塗って、足に追従させます調整します。

※ ウェイトの塗り方については解説しません。私もはっきりとわかってないです


### <u>シェイプキー</u>の修正

ポリゴンの削減作業の結果、全てのシェイプキーが下画像のように壊れます。どうやっても防ぐ方法はないようで、頑張って手作業で元の表情に近くなるように直します。

![リップシンクで「あ」を発言するとこうなる](./src/02_satalina_san_decimate/images/05_01_broken_shapekey.png)

![直した後の画像。あんまり違和感ない](./src/02_satalina_san_decimate/images/05_02_fixed_shapekey.png)

## Unityへインポート

### Quest用アバターとしてUnityにインポート

ここにきてようやくBlender側の作業のほとんどが一段落つきました。ここからUnityでの作業になります。
FBXファイルにエクスポートし、Unityに取り込みます。

PC向けアバターのマテリアルを複製し、Quest向けのマテリアルとして設定します。
Quest化における、シェーダー, マテリアルの設定や、アップロードに関しては、他の方による解説が豊富にあるため、本書においては省略します。

### 頬染めアニメーションを作り直す

元のモデルでは、頬染めアニメーションは **頬染め用のメッシュをシェイプキーで動かすことで** 表現されていました。
Quest対応化の影響で半透化画像が使えないので、 **頬染め用メッシュを使わず、顔のテクスチャを切り替える** 方法で対処します

通常の顔用マテリアルと、照れ顔用のマテリアルを用意し、照れ顔アニメーションでこれを切り替えるように設定します

![照れ顔Animationの設定](./src/02_satalina_san_decimate/images/06_01_shy_animation.png)

![ローポリで照れ顔対応できました](./src/02_satalina_san_decimate/images/06_02_shy_face.png)

### ベイク

最後に、MeshBakerを使って、オブジェクトのメッシュとマテリアルを結合し、テクスチャを<u>アトラス化</u>します。

焼き上がりのオブジェクトに VRC_AvatarDescriptorを設定して完成です！

![出来上がり](./src/02_satalina_san_decimate/images/07_01_result.png)

![ステータスはQuestでExcellentランク。対戦ありがとうございました](./src/02_satalina_san_decimate/images/07_02_status.png)

### VRChat上での確認

Quest2ユーザのフレンドに協力をお願いして撮影していただきました。こんな感じです。

![Questからの見た目です](./src/02_satalina_san_decimate/images/08_01_ss_on_quest.jpg)

![照れ顔もちゃんと表示されてます](./src/02_satalina_san_decimate/images/08_02_shy_animation_on_quest.jpg)


---
<div style="page-break-before:always"/>