# 作業準備

## 作業にあたって

本書執筆にあたり、サタリナ族のメイドさんのアバターをを参考資料として用意することにします。
私個人としても、このアバターはぜひQuest対応して使いたく、改変と平行して作業できるので丁度よかったです。

![サタリナさんはいいぞ](./src/01_preparation/images/satalina_san.png)

## 参考資料を見つけておこう

作業開始前に、参考資料にできるものを予め用意しておくと、作業効率や成果が劇的によくなるでしょう。
今回作業するにあたって、PC/Questの両対応アバターが同梱されている**人造アリス**ちゃんを参考にしました。

なお、本書においては、「ポリゴン数を削るための手順や手法」をまとめたものであり、 **ローポリ向けの表現のしかたをまとめるものではない**のでご注意ください。そういった技法は他人から盗むなどして各自でなんとかしてください。[^1-0]

[^1-0]: 正直私もこれは知りたい。まだ出来上がりは雑なので・・。

![人造アリスちゃんPC/Quest比較 (←Quest ⊿4732, →PC ⊿33362)](./src/01_preparation/images/artificial_alice_diff.png)

![ワイヤーフレームを表示させたもの。よく見てみると、服のシワ、指の形、髪の形、口の中など、細かいところで大きな違いがある。すごい。](./src/01_preparation/images/artificial_alice_diff_poly.png)

## 目標を設定する

さて、ここで一旦、アバターのQuest対応時におけるパフォーマンスランクの境界を確認しておきましょう。
以下は、公式 (2021/01/18時点) による、[アバターの要素別のパフォーマンスランクの境界値の一覧](https://docs.vrchat.com/docs/avatar-performance-ranking-system#quest-limits)から、今回必要になる部分のみを抜粋したものです。

: アバターの要素別パフォーマンスランクの境界値一覧 (一部)

||Excellent|Good|Medium|Poor|
|---:|:---|:---|:---|:---|
|**Polygons**|5,000|5,000|7,500|10,000|
|**Skinned Mesh Renderer**|1|1|2|2|
|**Mesh Renderer**|1|1|2|2|
|**Material Slot**|1|1|2|4|
|**Bones**|75|90|150|150|

....
Quest対応にはいくつか制限があり、まとめると以下のようになります。

<dl>
    <dt> Polygon </dt>
    <dd>Mediumなら7,500以下, Good/Excellentなら5,000以下<dd>
    <dt> <u>Mesh Renderer</u> / <u>Skinned Mesh Renderer</u> </dt>
    <dd> Mediumなら合計2つまで, Good/Excellentなら1つまで。</dd>
    <dt> Material </dt>
    <dd>
        <dl>
            <dt> <U>Material Slot</u> </dt>
            <dd> Mediumなら2つまで, Good/Excellentなら1つまで。<br /> マテリアル数ではなく、マテリアルスロット数であることに注意</dd>
            <dt> Shader </dt>
            <dd> `VRChat/Mobiles` 以下のシェーダのみ利用可能 かつ、 `VRChat/Mobiles/Particles` 以下は使用不可 </dd>
            <dt> Textures </dt>
            <dd> 透過のあるテクスチャは使用不可  </dd>
        </dl>
    </dd>
    <dt> Bones </dt>
    <dd>
        <dl>
            <dt> ボーン数 </dt>
            <dd> Mediumなら150以下, Goodなら90以下, Excellentなら75以下 <br /> 参考として、Humanoid Boneは 53 </dd>
            <dt> ボーン関連コンポーネント </dt>
            <dd> DynamicBone, Clothの使用不可 </dd>
        </dl>
    </dd>
    <dt> その他リソース </dt>
    <dd> オーディオ、パーティクル、トレイルの使用不可 </dd>
</dl>

## 大まかな手順

ローポリ化の作業は、大まかに以下の手順で進めていきます

1. ポリゴン・ボーンの削減 (Blender)
2. 崩れたデータの復元 (Blender)
3. マテリアル・オブジェクトの結合, テクスチャのアトラス化 (Unity)

どれも作業量は多いです。作業毎にバックアップをとったり、集中力が続くように精神統一したりしましょう。

バックアップにはGitがおすすめです。精神統一にはヨガがおすすめです。どちらも本書においては紹介しません。

## やること

### メッシュの削減

ポリゴン数を削る量が非常に多く、大胆に削り、場合によってはアクセサリや服の一部等の物体まるごとなくすなどの処理が必要になります。

基本的に、以下のメッシュは削除候補となります (サタリナさんでの例)

- 後頭部の頭皮
- 髪の裏面
- 服の裏面
- 服の内側にある下着、素体の見えない部分
- 口の中
- 靴の内側の素体
- 靴紐・髪飾り
- 首元のリボンの裏面

削減する条件は概ね **デティールが細かいもの** **見えづらい/見えない部分** は削除対象としましょう。

また、ポリゴンをなるべく多く削るために、わざと元のオブジェクトに見えにくい部分を作成することも有効です (以下はサタリナさんでの例)

- スカートの裏を埋め、内側の足・股まわりを消す
- 袖の内側を浅くして、袖付近の腕を消す


### 透過・半透過表現のあるもの

<dl>
    <dt> しいたけ目など、透過テクスチャの一部が使われている、かつ半島化ではない場合 </dt>
    <dd>メッシュの形を変形して、透過なしでも使えるように治す</dd>
    <dt> 半透過テクスチャや半透過のシェーダーが使われている場合 </dt>
    <dd>
        <dl>
            <dt>服の一部などに使われているもの </dt>
            <dd> 違和感がないように非透過画像に変更する。 </dd>
            <dt> 顔の照れ顔表現など、アニメーションに使用する場合 </dt>
            <dd>
                アニメーションで動かすメッシュを削除する。<br />
                アニメーションでは使用するテクスチャを変更する方法で対処する
            </dd>
        </dl>
    </dd>
</dl>

### 揺れもの

スカートや髪はダイナミックボーンを使って揺れを表現していましたが、Quest対応によって、動かなくなります。
動きに違和感をなくすために、スカートに、足のボーンに対するウェイトを塗る等の対処が必要になります。


### オブジェクトの表示・非表示を含むアニメーション表現

Excellent, Good対応においては、使用可能な <u>SkinnedMeshRenderer</u> 数が１つしかないため、使用できません。

Medium対応においては、アバターを1つの <u>SkinnedMeshRenderer</u>, 1つの <u>Material Slot</u> に結合するのであれば、１枠だけ余裕があります。


---
<div style="page-break-before:always"/>