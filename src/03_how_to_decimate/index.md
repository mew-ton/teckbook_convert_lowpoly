# 解説① ポリゴン数の削減

## 作業前に考慮しておくべきこと

### <u>シェイプキー</u>が全損する

前提として知っておくべきは、 **<u>シェイプキー</u>が全部壊れる** ことです。
これは、<u>デシメート</u>を使っても、手動で作業しても、必ず起こります。[^3-0]

[^3-0] [<u>Cats Blender Plugin</u>](https://github.com/GiveMeAllYourCats/cats-blender-plugin)  という、機械的なデシメートにシェイプキーを維持する機能があるプラグインも存在しますが、今回のような削減量が多いケースにおいては、うまく適用することが出来ませんでした。

そのため、ポリゴン数の削減後は、どうしても **<u>シェイプキー</u>の削減作業が発生します。
ポリゴン数の削減作業にて、<u>シェイプキー</u>で動く頂点を多く削ってしまうと、<u>シェイプキー</u>をもとに戻す際に、目的の形に変形しづらくなってしまいます。
そのため、ポリゴン削減の作業をする際には、事前に全てのシェイプキーについて、どの頂点がどう動くかを把握しておき、
それを考慮して削減作業をしていく必要があります。

### 透過テクスチャを利用するアニメーションをどう治すか

2章のおさらいになりますが、透過テクスチャを含むアニメーション、例えば頬染め表情などについては、 条件に応じて以下のように対処します。
見て分かる通り、Blender, Unity, テクスチャの修正など、作業全般を通して対処していく必要があります。


<dl>
    <dt> 透過部分と非透過部分がはっきりと別れている場合 </dt>
    <dd>サタリナさんにはないが、具体例としてはミーシェちゃんのしいたけ目が該当する。メッシュの形を変形して、透過なしでも使えるように治す</dd>
    <dt> 半透明のテクスチャやシェーダーが使われている場合 </dt>
    <dd>
        <dl>
            <dt>服の一部などに使われているもの </dt>
            <dd> 非透過でも違和感がないようにテクスチャを修正する。 </dd>
            <dt> 顔の照れ顔表現など、アニメーションに使用する場合 </dt>
            <dd>
                <strong style="color: red">シェイプキーで動かすメッシュを削除する</strong>。<br />
                アニメーションで使用するテクスチャを変更する。
            </dd>
        </dl>
    </dd>
</dl>


## 機械的な削減方法 (<u>デシメート</u>)

「Blender ローポリ化」 などで検索するとだいたい出てくるのが自動削減の方法です。方法は、以下の2種類がありますが、どちらも機能は同じです。[^3-1]

[^3-1]: ローカライズの関係でこうなっているようで、英語だとどちらも `decimate` という単語が使われているようです。

-  オブジェクトの編集モードで、 <u>メッシュ > クリーンアップ > 形状のポリゴン数削減 </u>
- オブジェクトの <u>モディファイア</u>から、 <u>デシメート</u>を追加する

![編集モードからデシメート](./src/03_how_to_decimate/images/01_01_how_to_decimate_in_edit_mode.png)

![モディファイアからデシメート](./src/03_how_to_decimate/images/01_02_how_to_decimate_in_modifier.png)

どちらも、設定項目、出来上がりは同じです。
Blenderの標準機能なので、具体的な使い方は調べるといくらでも出てきます。
私が探した限りだと、[こちら](https://horohorori.com/blender-note/modifiers/generate/about-decimate-modifier/) のリンク先が詳しいようです。

機械的に行ってしまうためか、削減具合によってはトポロジーが破壊されます。
今回のケースでは、 **削減量が多い** ため、特に以下のような副作用が発生する場合があります

- 関節にメッシュの切れ目がなくなり、曲げた時の形状が崩れる
- シェイプキーは確実に壊れる。また、シェイプキーを治すために必要な頂点が機械的に削減されており、直せなくなる。
- 変なところに穴が開く

しかし、手動での作業に比べて圧倒的に早く作業を終わらせれるだけでなく、
元の形状維持がしっかり出来ていて、思ったより出来栄えはよいので、採用する手も十分アリです。


## 自動削減のコツ

見えないポリゴン・見えづらいポリゴンを事前にしっかり手動で消してしまってから自動削減すると、効率よく削減できます。
また、オブジェクトを細かく分割する (例: 服のオブジェクト → ブラウスとスカートと靴と靴紐に分離する) と、デシメート結果にムラが出にくくなります。


## 手動での削減方法

### 事前準備: テクスチャの切れ目に印をつける

まず、事前にテクスチャの切れ目を探して、印を付けておきます。
テクスチャの切れ目となる辺は、辺上の頂点については問題ないですが、切れ目をまたぐように点や辺との結合を行うと、よからぬ副作用を生みます。
見た目がガクッと悪くなるだけでなく、 最悪の場合、**展開されるUVの破損**により**FBXエクスポート時にエラーとなってしまう**こともあります。

※ エラーになってしまった場合はTipsに修正方法を掲載しているので、そちらを参照してください

作業開始前に、どこが切れ目にあたるかを把握し、なるべくいじらないように目印をつけておくと、安心できると思います。

自分の場合だと、<u>シーム</u>をガイドに見立てて設定しています。 (シームの本来の使い方ではないです。)

![作業前に<u>UV Editing</u>で、端がどこにあるか探しておきます ](./src/03_how_to_decimate/images/05_01_texture.png)

![テクスチャの切れ端にマークしました。削減作業するときは、この辺の形は絶対に維持します。](./src/03_how_to_decimate/images/05_02_texture_marked.png)

### 手動削減の方法

以下に示す3種類の操作をひたすら繰り返して、頂点・辺をどんどん削っていきます。[^3-2]

[^3-2]: 再三記載しておりますが、本書においては、削減するための方法のみを掲載し、見た目良く削減するコツについては掲載しません。私が知りたいです。

#### 操作1: 不要そうな辺の<u>融解</u>

辺を選択して融解します。単純に整列したメッシュが並んでいるところでは、下図のように等間隔に選択して融解すると、かなり簡単にポリゴン数を削減できます。

![等間隔に辺ループを選択して・・](./src/03_how_to_decimate/images/02_01_select_lines.png)

![<u>辺を融解</u>する。いい感じに削れる](./src/03_how_to_decimate/images/02_02_remove_lines.png)


#### 操作2: 頂点をスライドして結合

結合したい頂点を複数選択し、<u>頂点をマージ</u> します。 `UV`にチェックを入れることで、元のままのUVを維持したまま頂点を結合できます

※ 全く崩れないわけではないです

![UVにチェックを入れない場合](./src/03_how_to_decimate/images/03_01_merge_without_uvfix.png)

![UVにチェックを入れる場合](./src/03_how_to_decimate/images/03_02_merge_with_uvfix.png)


#### 操作3: 辺をスライドして結合

複数の頂点をまとめて結合する場合は、それらの頂点を <u> 頂点スライド</u>をつかって重ね合わせた後、 頂点を **距離から** マージします。
辺のループをまとめて結合したいときに便利です。


![動かしたい辺ループを選択して、まとめて <u>頂点をスライド</u>](./src/03_how_to_decimate/images/04_01_move_line.png)

![重ね合わせたら・・<u>頂点をマージ</u> → <u>距離から</u>](./src/03_how_to_decimate/images/04_02_merge_line.png)


## 手動削減時の注意点

### 関節のループを忘れずに

関節にはかならずループとなる辺を最低１つは残しておきましょう。関節に辺ループがないと、ボーンを曲げたときに、形が曲がらなくなります。

![指の関節に、外側に2本・内側に1本でループを作ってます。これで綺麗に曲がります。](./src/03_how_to_decimate/images/06_01_finger.png)


### シェイプキーの破損を考慮する


再三記してますが、シェイプキーはポリゴン削減作業によって必ず破損します。
削減作業後の修復作業で手作業でシェイプキーを作り直す必要があります。
ここで、シェイプキーで動く頂点を削りすぎてしまうと、元のシェイプキーを動かした時の形に近づけにくくなります。
なるべく頂点を残すようにしましょう。

## 表情修正のための手直し

### 半透過でない場合 (漫符表現など)

例えばミーシェちゃんには、目の漫符表現 (しいたけ目、 ><、閉じた目のまつげなど) に透過が使われています。

テクスチャをよく見ると、半透過のグラデーションではなく、透過と非透過がはっきりと別れています。
このようなケースでは、メッシュの形を非透過部分の形に合わせて作り直すことで、透過を使用せずに表情を使えるようになります。

メッシュの形を変えたので、当然ながらシェイプキーにも対応させます。また、半透過の場合の対処と異なり、こちらではUnity側での修正は不要です。

![かわいい！](./src/03_how_to_decimate/images/07_01_mishe_siitake.png)

![しかしUVを見てみると・・透過が使われているのがわかります。](./src/03_how_to_decimate/images/07_02_mishe_siitake_uv.png)

![しいたけ目のポリ割りを右のように直していきます](./src/03_how_to_decimate/images/07_03_siitake_remesh.png)

![こんな感じです。どうでしょう](./src/03_how_to_decimate/images/07_04_result.png)


### 半透過の場合 (頬染めなど)

全貌は把握できていませんが、大半のアバターの頬染め表現には半透過が使われています。
半透過でない場合はメッシュの形を変更する方法で対処できますが、半透過の場合は境界線が曖昧であり、同様の対処ができません。

別の手段として、Unity側のアニメーション設定で、使用するテクスチャを切り替える方法があります。
頬が染まっている状態の顔のテクスチャと、通常の顔のテクスチャを切り替えます。

つまり、 頬染め用のメッシュが不要になるため、まるごと消す対応をします。
Unity側での作業方法については、後述します。

---
<div style="page-break-before:always"/>