# 解説② 削減後の修復

## 法線破損の修復

頂点の移動や結合を繰り返した結果、 <u>法線</u>が大きく崩れてしまいます。
<u>法線</u>を表示してみると、線の方向が各頂点でバラバラになってしまっているのがよく分かると思います。

![法線方向を表示してみるとこんな感じに。 (自分はよくわからず)](./src/04_how_to_fix/images/01_01_broken_normal_guide.png)

以下の操作で調整します
- 修正したいオブジェクトを選択し、<u>オブジェクトデータプロパティ</u>から、 <u>形状データ</u>内の <u>カスタム分割法線データを削除</u> ボタンを押す
- 修正したいオブジェクトを選択し、<u>オブジェクトデータプロパティ</u>から、 <u>ノーマル</u>内の <u>自動スムーズ</u> にチェックを入れ、角度の値を大きくしていく。袖や指などのメッシュの角になる部分が角っぽくなればOK

見た目では分かりづらいですが、顔以外の全オブジェクトでこの現象が起きているはずなので、全てのオブジェクトに行っておきます。

![ここで修正する](./src/04_how_to_fix/images/01_02_fix_normals.png)

## ボーンの調整

### 不要なボーンの削除

QuestでのMedium以下のランクを目指す際、ボーン数の制約をクリアする必要があります。
Quest対応後のアバターでは、基本的にumanoid以外のボーンは動かないため、不要となります。

### 一部ウェイトの塗り直し

サタリナさんの作業記録では、スカートのボーンの削除と、これを足のボーンに紐付けるためのウェイトの塗り直しを行っていました。
アバターによりけりではありますが、こういったウェイトの塗り直し作業が発生する場合があります。

こういった作業は、一般的な「服にウェイトを塗る作業」とほぼ同じなので、具体的な解説については省略します。

![ない知識で頑張って塗りました。私自身、ウェイトの塗り方は熟知してません。](./src/04_how_to_fix/images/03_01_fix_weight.png)

### Humanoid以外のボーンが必要になるケース

そこそこニッチな条件ですが、以下のようなケースで、Humanoidボーン以外が必要になることがあります。
削減作業で間違って消さないように注意しましょう。

- FinalIKを使って髪をDynamicBoneのように揺れ動かす対応をする場合
- アニメーションで動かすボーン

## シェイプキーの破損と修復

### 破壊は防げない?

ポリゴン数の削減作業の影響で、全てのシェイプキーが破損します。
調べた限り、これを予防する方法は見つかりませんでした。そのため、ポリゴン削減後の作業として、シェイプキーの全修復作業を行います。[^4-1] [^4-2]
どうしても、手作業での修復が必要になってしまいます。この事実を諦めて受け入れましょう。

[^4-1]: ブレンドシェイプからデシメートを設定する場合は、適用していない間は壊れていないように見えることがあります。しかし、結局の所、シェイプキー適用後は確実に壊れます。なぜなのか。

[^4-2]: 破損したシェイプキーの修復方法で調べてみると、情報が結構出てくるようですが、これらの情報は全て **頂点数を減していない** 前提であるため、今回のケースにおいては概ね役に立ちません。

### 修復方法の選択

方法は３つ有りますが、それぞれ条件によって使える方法が異なります。具体的には以下の通り。[^4-3]

[^4-3]: シェイプキーの修復方法の紹介にて、Blenderの基本機能である <u>シェイプキーの転送</u> については紹介できませんでした。頂点数が異なり、元の形状も異なるオブジェクトに対して転送しようとすると、エラーになってしまいました。残念です。

|方法|手間具合|条件|
|:---|:---|:---|
|方法1: リセット|超楽|Basisと同じ形状になるシェイプキーの場合|
|方法2: シュリンクラップ|単純作業の繰り返し|構造が単純, かつシェイプキーの適用前後で大きく頂点位置が異なる場合, もしくは運がいい時|
|方法3: 手動修復|苦行|それ以外|

私が行ったサタリナさんの作業を例に挙げると、シェイプキー毎にそれぞれ以下のように作業しています。

- Body
    - VRCのアバターシステムが利用するために割り当てておくdummyシェイプキー４つ .. 方法1
    - それ以外全て .. 方法3
 - Costume
    - 胸の縮小 .. 方法2


### 方法1: 全てのシェイプキーをリセットする

Basisと同じ形状になるシェイプキーについては、以下の手順でシェイプキーをBasisに合わせることが出来ます。
`Body`オブジェクトのシェイプキーのリスト上から４つ目までは、基本的にBasisと同じ形状となるので、これを行っておきます。

1. 壊れたシェイプキーに対して編集モードにする
2. 壊れている頂点のみを全て選択する (残したい頂点を選択して反転でもOK)
3. <u>頂点</u> > <u>任意のシェイプキーを選択部に合成</u> を選択
4. Basisを選択, ブレンド: 1.0, 「追加」はチェックを外して適用

![爆発を全部選択して、<u>任意のシェイプキーを選択部に合成</u>](./src/04_how_to_fix/images/04_01_fix_to_clean.png)

![設定値はこんな感じ](./src/04_how_to_fix/images/04_02_fix_to_clean_option.png)

### 方法2: <u>シュリンクラップ</u>

<u>シュリンクラップ</u>を使って、元のモデルに対して近似させる方法があります。
胸や体型など、広い範囲での形状変化がある場合に、この方法は有効です。
逆に、口元や表情などの頂点が密集している箇所でこの方法をつかうと、シュリンクラップがうまくいかなかったり、仮にうまくできたとしても、メッシュが汚かったりします。

以下の手順で行います。

[^4-2]: 苦痛であることに変わりはあまりないです.

#### 事前準備

- 修正対象のシェイプキーの名前とリスト上の位置を控えておき、削除しておく
- 元のモデルをインポートし、作業対象モデルと座標を一致させる。
- 元のモデル側のオブジェクトに、作業対象のシェイプキーの値を `1.0` に設定しておく
- 修正したいシェイプキーで動く頂点を、名前は何でも良いので <u> 頂点グループ </u>として登録しておく

![胸のシェイプキーを手直しするので、このへんをグループ化する](./src/04_how_to_fix/images/05_01_create_vgroup.png)

#### 手順

1. 作業対象のオブジェクトを選択し、<u>モディファイア</u>から、<u>シュリンクラップ</u>を追加
2. ターゲットを元オブジェクトに、頂点グループを事前準備で作ったものに設定する
3. <u>シェイプキーとして適用</u> を押すと、シェイプキーの一覧の一番下に、 `ShrinkWrap` という名前でシェイプキーができる
4. シェイプキーを元の名前に直し、元の位置になるまで上に移動する。シェイプキーの形が崩れているなら、これを <u>頂点のスライド</u> のみで手直しする

![モディファイアの設定と結果](./src/04_how_to_fix/images/05_02_modifier_option.png)

![シュリンクラップをシェイプキーに適用後、頂点位置やUVを微調整。やることは頂点スライドのみ。](./src/04_how_to_fix/images/05_03_shrink_wrap_result.png)

![結果の比較 左は作業結果、右は元のモデル](./src/04_how_to_fix/images/05_04_shrinked_diff.png)


### 方法3: 手動で対処

手動で手直しする場合は、下記の手順で行います。

#### 事前準備

- 修正対象のシェイプキーを全て、**方法1**を使ってリセットしておく
- 元のモデルをインポートし、作業対象と座標を一致させる。
- 元のモデル側のオブジェクトに、作業対象のシェイプキーの値を `1.0` に設定しておく
- <u>ビューボードオーバーレイ</u>から、ワイヤーフレームを表示しておく

#### 手順

1. 作業対象のオブジェクトに対して
2. <u>スナップ</u>を有効化、<u>スナップ先</u> を **頂点** か、 **辺** にする
3. ハイポリ・ローポリのオブジェクトの頂点が密集する中から、ローポリの頂点を選択し、ハイポリ側の頂点か辺に合わせて移動する
4. 全て移動し終わったら、<u>スナップ</u>を解除し、頂点を微調整する

![スナップは中央上の磁石マーク、スナップ先はそのとなりにある。](./src/04_how_to_fix/images/05_05_snap_setting.png)

### コツ

#### LとRに分かれているシェイプキーを方法3で治す場合

それぞれ対処するのは手間なので、左右まとめてやりましょう。具体的には以下の手順を踏みます。

1. 両方とも動かした状態をシェイプキーとして設定するため、新しいシェイプキーを作成する。 (名前は何でも良い)
2. 方法3で作業をする。その際、<u>X軸対象編集</u> を有効にする。
3. LかRのどちらかのシェイプキーを編集するモードに切り替える。
4. Lの場合は左半分の全体の頂点を選択し、 <u>任意のシェイプキーを選択部に合成</u>から、2で作ったシェイプキーを合成する。 Rにも同様に。

#### スナップの操作ミスを防ごう

スナップは、操作ミスによって、よからぬ事故を引き起こす原因を引き起こしやすいため、こまめに無効化するのをおすすめします。

#### 頂点が多すぎて作業しづらい場合

任意の範囲のみを表示する機能が標準で備わっています。作業前に、作業対象の頂点を全て選択した状態で `Shift + H` キーで、選択範囲以外を非表示化すると、非常に見やすく作業できます。もとに戻すには `Alt + H`

![この状態で作業しろと？無茶をおっしゃる](./src/04_how_to_fix/images/05_06_dots.png)

![作業対象でない頂点を全部非表示に](./src/04_how_to_fix/images/05_07_hide_dots.png)

### 補足

#### 動く頂点がなくなったシェイプキーはどうするべき？

削除してもよいと思います。もしくは、残しておく場合は方法1を使ってリセットし、暴発を防ぎましょう。


#### <u>シェイプキーの転送</u> / <u>シェイプキーとして統合</u> は使えないの？

Blenderの標準機能に、別オブジェクトの形状を使ってシェイプキーを作成する、<u>シェイプキーの転送</u> <u>シェイプキーとして統合</u> という機能がありますが、今回は使えません。
転送元と転送先のオブジェクトの頂点数が異なるため、これらの機能を使おうとするとエラーとなります。残念。

#### シェイプキーの名前について

元と同じ名前にしましょう。同名であれば、 **Unityに取り込んだ時に、元モデルと同一のアニメーション設定を併用できます**。

---
<div style="page-break-before:always"/>