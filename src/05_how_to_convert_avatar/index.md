# 解説③ 最後の調整とアバター化

## Unityにインポート

ようやくBlenderでの作業が完了したと言ってもいいでしょう。

### FBXエクスポート

作成したオブジェクトをFBXファイルにエクスポートし、Unity側にインポートします。

一般的なやり方と同じですが、念の為、エクスポート時のパラメータは以下のようにしましょう。
また、作業工程で作成した他のオブジェクトももう使用しないので、消してしまって問題ないです。

- オブジェクトタイプ: アーマチュア・メッシュ・その他
- スケールを適用: すべてFBX
- !実験的機能! トランスフォーム適用:  ☑をつける
- リーフボーン追加: ☑をはずす

### マテリアルを事前に作っておく

使用するマテリアルを先に作っておきましょう。 **後ほどベイクする事を考慮し、使用するシェーダーは全て同一のものを使います**

### Unityに取り込み

Unityプロジェクト内のフォルダのどこかに、エクスポートしたFBXファイルを配置します。
配置後、Unityを開くと、自動的に取り込んで使用可能になってくれます。
このとき、FBXファイルに3Dモデルのサムネイルが表示されていなければ、正常に出力できなかった可能性があるので、Blenderの出力結果等を確認します。

正常に取り込めたなら、FBXファイルを選択し、<u>インスペクター</u>から、以下のように設定します

- Model .. 関係ないところなので、各自最適な設定をする
- Rig .. AnimationType を <u>Humanoid</u> に設定。 AvatarDefinitionを `Create From This Model` のまま、Applyする。設定が提要されるとConfigureボタンが有効化されるので、必要なら開いて調整する
- Animation .. importしない
- Material .. 各マテリアルのスロットに、対応するマテリアルを作成し、セットする。それぞれ、Quest対応のために VRChat/Mobileシェーダーのみを設定しよう。

設定が完了したら、<u>ヒエラルキー</u>にFBXファイルをドラッグ・アンド・ドロップし、頑張って作ったアバターをシーンに表示させて取り込み完了です。

![Unityにインポートできました！違和感なし！ヨシ](./src/05_how_to_convert_avatar/images/00_01_imported_to_unity.png)

![<u>Prefab</u>のアイコンが水色で、紙のアイコンがついていればOKです。](./src/05_how_to_convert_avatar/images/00_02_prefab.png)

### 取り込んだ後の注意点

ヒエラルキーに設置したオブジェクトについて、<u>Unpack Prefab</u>もしくは、<u>Create Prefab</u> を行わないでおきましょう。
Prefabのアイコンに紙のマークがある状態だと、FBXファイルになんらかの更新を行った時、更新がちゃんと反映されるようになります。

## テクスチャの調整

ポリゴン削減作業でアクセサリー等の物体を消すと、アバターにはその影が残っていて違和感のある外観になってしまうこともあります。
サタリナさんの場合だと、ブーツの靴紐を消した影響で紐の影が残っています。

アバターに同梱されるテクスチャの構成によるため、一概に統一された対処法はありません。
PSDファイルの内容に影のレイヤーがなく、全てのレイヤーが一つに統合されている構成の場合は、基本的に、GimpやPhotoshopなどのツールで、 <u>スタンプ機能</u> を使用すると、たいていの場合で対処が可能です。

![紐の影が残っています](./src/05_how_to_convert_avatar/images/02_01_fix_texture_shades.png)

## アニメーションの復元

### 頬染め以外のアニメーション

実はほとんど作業不要です。というのも、ポリゴン削減の作業において、シェイプキーを変更していないため、PCのアニメーションがそのまま適用されるためです。
念の為、使用する全てのアニメーションが、ちゃんと目的の表情になるか、確認しておいたほうがいいでしょう。

![問題なければ、プレビューでちゃんと表示されています](./src/05_how_to_convert_avatar/images/03_00_preview_anim.png)

### 頬染め表情の復元

ポリゴン削減作業において、頬染め要の頬のメッシュをごっそり削除したため、照れ顔の頬染めを使えなくなっています。
その対処として、頬染めが適用されている状態をテクスチャ側で用意し、アニメーションで切り替えるようにします。

Gimp, Photoshop等のソフトを使って、頬染め状態の顔と、そうでない顔のテクスチャをそれぞれ用意します。それぞれ、通常状態の顔と、頬染めアニメーション適用時の顔とします.
マテリアルも同様に、通常と頬染めで包囲します。

![左: 通常  右: 頬染め](./src/05_how_to_convert_avatar/images/03_01_cheek_diff.png)


次に、照れ顔のアニメーションをQuestアバター用として複製し、 `Body: Skinned Mesh Renderer.Material Reference[0]` を追加します。出てきたマテリアルスロットに、用意していた頬染め用のマテリアルをドラッグ・アンド・ドロップして完成です。

![アニメーションにマテリアル変更を追加](./src/05_how_to_convert_avatar/images/03_02_shy_animation.png)

![プレビューしてみるとこんな感じになります](./src/05_how_to_convert_avatar/images/03_03_shy_result.png)

## マテリアルをベイク

### 事前準備: テクスチャの最適化

使用するテクスチャの最適化を行います。この作業は、次に行うベイクの結果に大きく左右されるので、必ずやりましょう。
使用するテクスチャをクリックし、Inspectorから、以下のように設定して、Applyを押します。

- Texture Type .. Default
- Alpha Source .. None
- Read/Write Enabled .. チェックを外す
- Streaming Mip Maps .. チェックを外す
- Generate Mip Maps .. チェックを入れる
- Wrap Mode .. Clamp
- Max Size .. 後述
- Use Crunch Compression .. チェックを外す

![こんな感じに設定する] (./src/05_how_to_convert_avatar/images/04_01_optimise_images.png)

#### テクスチャのサイズ調整

Excellentを目指す場合はマテリアルを1つにまとめなければならず、合わせてテクスチャ1枚に仕上がるように調整しなければなりません。(今回は2kのテクスチャ1枚にまとめます.)
**見た目に違和感がないギリギリまで** 小さいサイズにしましょう。小さすぎると線や輪郭がぼやけてしまいますが、大きすぎるとベイク時に <u> アトラス化 </u> の作業に邪魔になります。

ここでの適切な大きさは **ベイクの手法によって異なる** ため、一概に説明はできません。

以下に説明する <u>MeshBaker</u>では、アトラス化の結果となるテクスチャのサイズを指定することができ、
また、UVとテクスチャの位置や比率を調整してアトラス化してくれる機能があります。
オススメです。

他のベイク手法については、私自身の調査不足もあって、解説は不可能です。他の手法を使う際は、出来上がりがどうなるかを先に把握し、その上でテクスチャのサイズを調整しましょう。

### 事前準備: QuestとPCで作業領域を分けておく

PC向けとQuest向けで、テクスチャやマテリアルをフォルダ分けておきましょう。混同すると、わけわからなくなりますよ。
また、ベイク結果を配置するためのフォルダをどこかに用意しておきましょう。

### MeshBakerの作成とセットアップ

MeshBakerには様々なモードがありますが、今回は目的に合わせて **複数のメッシュ・マテリアル・テクスチャをそれぞれ１つにまとめて出力する** モード (Texture And Mateiral Baker) を使用します。
まず、ローポリのアバターオブジェクトがヒエラルキーに配置されているシーンに、<u>Texture And Material Baker</u> を作成します

![ここから。](./src/05_how_to_convert_avatar/images/05_01_create_mesh_baker.png)

![各Bakerが配置されました](./src/05_how_to_convert_avatar/images/05_02_placed_baker.png)

配置されたオブジェクトのうち、 `Texture Baker (0)` はテクスチャのアトラス化とマテリアルの結合、
内側の `Mesh Baker` は `Texture Baker (0)`の設定を元にメッシュの結合を担当します。

#### ベイク対象のオブジェクトを設定する

`Texture Baker (0)` を選択すると、インスペクターには画面のようにドロップエリアが出てきます。
ベイクしたいオブジェクトを全てドロップエリアに対してドラッグ・アンド・ドロップしましょう。

![ここからここに](./src/05_how_to_convert_avatar/images/05_03_dnd.png)

![これでOKです](./src/05_how_to_convert_avatar/images/05_04_after_dnd.png)

※ 同じオブジェクトを複数設定しないように注意しましょう。

#### 作業ファイル・出力先の設定

インスペクターを少し下に進むと、 `Output` の項目があります。`Result Type` を `Atlas` に設定し、その真下のボタンを押して、TextureBakerの作業用ファイルの保存先を設定します。
保存した先の同じフォルダには、ベイク結果のテクスチャやマテリアル、メッシュが配置されます。他の作業ファイルと混同しないように、フォルダを分けておくのをおすすめします。

![Outputの項目](./src/05_how_to_convert_avatar/images/05_05_material_output_setting.png)

![baked.asset として保存したら、早速Materialが設置されました。これから作業した結果がこのファイルに上書きされていきます](./src/05_how_to_convert_avatar/images/05_06_output_path.png)

### テクスチャ・マテリアルの結合

さらに下に進むと、マテリアルの結合オプションと、結合開始のボタンが出てきます。
以下のオプションの説明を参考に設定し、 `Bake Material Into Conbined Material` ボタンを押して、マテリアルのベイク・テクスチャのアトラス化を実行します。
実行した結果は、先程保存した出力先のフォルダに配置されます。

<dl>
    <dt>Atlas Padding</dt>
    <dd> アトラス化に使う各テクスチャに境界線を追加して、隣接するテクスチャが互いに干渉しないようにする。`1` が設定されていればOK </dd>
    <dt> **Max Atlas Size** </dt>
    <dd> 出力画像サイズ </dd>
    <dt> Resize Power-Of-Two Textures</dt>
    <dd> Paddingがある場合、各テクスチャを縮小して、paddingと合わせて元画像のサイズになるようにする。 `Unity's Pack Texture` を使う場合のみ必要の模様。</dd>
    <dt> Max Tiling Bake Size</dt>
    <dd>使用するテクスチャの最大サイズ</dd>
    <dt> **Consider Mesh UVs** </dt>
    <dd>アトラス化の際に、UVの配置を考慮する。無駄なスペースを省いてくれたり、テクスチャの外にはみ出たUVを範囲内に収めるように調整してくれたりする。</dd>
    <dt>Force Power-Of-Two Atlas</dt>
    <dd>公式説明なし.チェックを入れておいたほうが良いらしい・・？。 ※ 判明しだい記載を変更します</dd>
    <dt> Blend Non-Texture Properties</dt>
    <dd>テクスチャの画像以外の要素をベイク結果の情報に付加する。ベイク結果のマテリアルシェーダに、TextureBlenderのスクリプトを書き込む必要がある。<br />今回はMobile用シェーダーで、パラメータが殆どないので、使わない</dd>
    <dt>Texture Packer</dt>
    <dd>アトラス化の手法を選択する。詳細は後述</dd>
    <dt>Custom Shader Propert Names</dt>
    <dd>結合結果のマテリアルに使用されるシェーダーの各パラメータの設定。今回はMobielシェーダー固定のため設定不要</dd>
</dl>

![設定項目](./src/05_how_to_convert_avatar/images/05_07_bake_material_setting.png)

#### Texture Packer

Texture Packerのプルダウンで選択できるアトラス化の手法を説明します。

<dl>
    <dt>Unity's Pack Texture</dt>
    <dd>Unityの標準機能として搭載されているアトラス化手法。コレを使うならMeshBakerを使う意味が皆無。アトラス化結果ではみ出してしまう場合は、元画像をリサイズする場合がある</dd>
    <dt>Mesh Baker Texture Packer</dt>
    <dd>Mesh Bakerによるテクスチャのアトラス化手法を使う。メモリ使用量が最適化されている。アトラス化結果ではみ出してしまう場合は、元画像をリサイズする場合がある。 **これが設定されていれば基本OK**</dd>
    <dt>Mesh Baker Texture Packer Fast</dt>
    <dd>GPUを使ってアトラス化する。結果に差はあんまりない。ランタイムでのテクスチャベイクに向いてる。</dd>
    <dt>Mesh Baker Texture Packer Horizontal / Vertical</dt>
    <dd>アトラス化する際に、元画像を垂直方向か、水平方向に積み上げていく。 "Consider Mesh UVs" は有効にしないほうがよい</dd>
</dl>

#### ベストプラクティス

MeshBakerの公式より、最高効率かつ手間なくベイクするための条件は以下のとおり

- 全てのマテリアルが使用するシェーダーが同じである
- 複数のマテリアルから１つのテクスチャを参照する構成になっていない
- 全てのテクスチャのサイズが同一である

#### アトラス化例

テクスチャサイズ
- 素体 .. 1024
- 下着 .. 1024
- 顔 .. 1024
- 髪 .. 1024
- 服 .. 2048

アトラス化設定
- Max Atlas Size .. 2048
- Max Tiling Bake Size .. 2048
- Consider Mesh UVs .. チェックをいれる
- Force Power-Of-Two Atlas .. チェックを入れる
- Texture Packer .. Mesh Baker Texture Packer

Consider Mesh UVs を有効にした影響で、テクスチャの使われていない部分を省略してくれています。また、テクスチャに設定したサイズを考慮して、比率を調整して縮小してくれています。
素晴らしい！

出来上がったテクスチャについても、同様のテクスチャの最適化設定をしておきます。

![アトラス化結果の2kテクスチャ](./src/05_how_to_convert_avatar/images/05_08_texture_atlas_result.png)

## メッシュをベイク

### メッシュベイクの設定

ようやくメッシュをベイクする作業に入ります。MaterialBakerの設定を更に下にスクロールしていくと、画像のような項目がでてきます。
これはメッシュベイクの設定項目です。

Quest化のためのモデルベイクなので、基本的に以下の設定通りにすればOKです。

- Include Normals .. チェックを入れる必要はなさそう。とりあえずデフォで入ってるのでそのまま
- Include Tangents .. 同上
- Include UV .. **チェックをいれる**
- Include UV3 ~ 8 .. チェックを入れる必要はない
- Include Blend Shapes .. **チェックを入れる**
- LightmappingUVs .. デフォルトのままに
- Renderer .. **Skinned Mesh Renderer**
- Clear Buffers After Bake .. **チェックをいれる**
- Pivot Location Types .. **Bounds Center**
- Optimize After Bake .. **チェックをいれる**
- No Extra Bones For Mesh Renderers .. 不明
- Merge Blend Shapes With Same Names .. **チェックを入れる**

### メッシュベイクの出力先設定

今回は `Bake Into Prefab` を出力設定とした方法で行っていきます。出力先を用意する手順は以下の通り。

1. ヒエラルキーに出力先となるオブジェクトを 右クリック → `Create Empty` から作成する
2. 作成したEmptyオブジェクトに適当な名前をつけ、プロジェクトにドラッグ・アンド・ドロップし、Prefabを作成する
3. ヒエラルキーの `Mesh Baker`をクリックし、インスペクタにて、`Output` を `Bake Into Prefab` にする
4. 設定したコンボボックスの真下にPrefabをセットできる欄がでてくるので、そこに先程のPrefabを設定する

![ここ！](./src/05_how_to_convert_avatar/images/05_09_mesh_baker_setting.png)

### メッシュベイク

`Bake` ボタンを押す！以上！！

ベイクと聞くと、ワールド製作者が口を揃えて、ベイクに数時間かかるとぼやいているのを聞きますが、
5000ポリアバターのベイクは５分もかからないです。とても快適

![瞬で焼き上がりました](./src/05_how_to_convert_avatar/images/05_10_bake_result.png)

焼き上がると、出力要に作成したEmpty Objectの中身に色々入っているのがわかります。
それぞれ内容は以下の通りです。

- MeshBaker-mesh-mesh .. ベイク結果のアバターのオブジェクト
- decimated_satalina_san(Clone) .. ベイク元のオブジェクトのコピー (中身のオブジェクト構成は全く同じ)

### 頬染めアニメーションへの対応も忘れずに

マテリアルをベイクした結果、さきほど作成した頬染めのアニメーションの見た目が壊れます。

顔のマテリアルを頬染めマテリアルに変更し、マテリアルベイクを再度行っておきましょう。
頬染めアニメーションで切り替えるマテリアルを、ベイクしたマテリアルに設定すれば治ります。

## 焼き上がりをアバター化

焼き上がったオブジェクトの内容を手直しして、アバターに変えていきます。以下のように手直しします

- ルートオブジェクト .. インポートしているAvatarSDKの <u>VRC-Avatar Descriptor</u>を追加し、各項目を設定 (後述)
- MeshBaker-mesh-mesh .. Bodyに名前を変える
- decimated_satalina_san(Clone) .. 中からArmatureを適切な場所に移動し、それ以外のオブジェクトはいらないので消す

![一般的なアバターと同じ構成に直します](./src/05_how_to_convert_avatar/images/06_00_fix_baked.png)

### アバターの設定

基本的にPCアバターと同じでよいです。

### 念の為・・

BlendShapeやアニメーションの表示確認を行っておきましょう。

## 手直しする場合

出来上がった後VRChatにアップロードしてみると、ところどころ気になるところが出てくると思います。
テクスチャの服の皺がローポリ化のせいで違和感が出るようになったとか、
首に穴が空いているとか、、細かいミスや違和感は作業中には発見できないものです。

作業を巻き戻して修正しても問題はありませんが、苦行が多いので、あまり推奨したくないです。

### Blender作業後の場合

Unityのヒエラルキーにドラッグ・アンド・ドロップしたFBXファイルに上書きする形でエクスポートします。
うまくいけば、ヒエラルキー上のオブジェクトにそのまま反映されます。

メッシュの変更を行ったので、メッシュのベイク作業をし直す必要があります。マテリアルのベイクは不要です。

### テクスチャ・マテリアル調整後の場合

マテリアルのベイク・テクスチャのアトラス化をやり直します。

ベイクのし直しは不要です。また、この変更によって見た目に問題がないか、よく確認しましょう。アニメーションも忘れずに。


---
<div style="page-break-before:always"/>
